<?xml version="1.0" encoding="utf-8"?>
<Project
    DefaultTargets="nBuildKit_Build_Test_Unit_MsTest_Run"
    ToolsVersion="11.0"
    xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <!-- Defines whether the current script file has been loaded / imported or not -->
        <ExistsBuildTestUnitMsTest>true</ExistsBuildTestUnitMsTest>
    </PropertyGroup>

    <Import
        Condition="Exists('$(DirNBuildKitMsBuildShared)\shared.importbuildsharedsettings.props') AND '$(ExistsSharedImportBuildSharedSettings)' != 'true' "
        Project="$(DirNBuildKitMsBuildShared)\shared.importbuildsharedsettings.props" />

    <Import
        Condition="Exists('$(DirNBuildKitMsBuild)\shared.templatetokens.msbuild') AND '$(ExistsSharedTemplateTokens)' != 'true' "
        Project="$(DirNBuildKitMsBuild)\shared.templatetokens.msbuild" />

    <Import
        Condition="Exists('$(DirNBuildKitMsBuildExtensions)\GetToolFullPath.msbuild') AND '$(ExistsExtensionsGetToolFullPath)' != 'true' "
        Project="$(DirNBuildKitMsBuildExtensions)\GetToolFullPath.msbuild" />
    <Import
        Condition="Exists('$(DirNBuildKitMsBuildExtensions)\NuGetInstall.msbuild') AND '$(ExistsExtensionsNuGetInstall)' != 'true' "
        Project="$(DirNBuildKitMsBuildExtensions)\NuGetInstall.msbuild" />
    <Import
        Condition="Exists('$(DirNBuildKitMsBuildExtensions)\OpenCover.msbuild') AND '$(ExistsExtensionsOpenCover)' != 'true' "
        Project="$(DirNBuildKitMsBuildExtensions)\OpenCover.msbuild" />
    <Import
        Condition="Exists('$(DirNBuildKitMsBuildExtensions)\ReportGenerator.msbuild') AND '$(ExistsExtensionsReportGenerator)' != 'true' "
        Project="$(DirNBuildKitMsBuildExtensions)\ReportGenerator.msbuild" />
    <Import
        Condition="Exists('$(DirNBuildKitMsBuildExtensions)\ReportGeneratorOutputToCsv.msbuild') AND '$(ExistsExtensionsReportGeneratorOutputToCsv)' != 'true' "
        Project="$(DirNBuildKitMsBuildExtensions)\ReportGeneratorOutputToCsv.msbuild" />
    <Import
        Condition="Exists('$(DirNBuildKitMsBuildExtensions)\SearchPackagesDirectoryForToolPath.msbuild') AND '$(ExistsExtensionsSearchPackagesDirectoryForToolPath)' != 'true' "
        Project="$(DirNBuildKitMsBuildExtensions)\SearchPackagesDirectoryForToolPath.msbuild" />
    <Import
        Condition="Exists('$(DirNBuildKitMsBuildExtensions)\SortFilesByDirectory.msbuild') AND '$(ExistsExtensionsSortFilesByDirectory)' != 'true' "
        Project="$(DirNBuildKitMsBuildExtensions)\SortFilesByDirectory.msbuild" />
    <Import
        Condition="Exists('$(DirNBuildKitMsBuildExtensions)\TemplateText.msbuild') AND '$(ExistsExtensionsTemplateText)' != 'true' "
        Project="$(DirNBuildKitMsBuildExtensions)\TemplateText.msbuild" />

        <CallTarget Targets="_nBuildKit_Build_Test_Unit_MsTest_GetToolPaths" />
        <CallTarget Targets="_nBuildKit_Build_Test_Unit_MsTest_ReplaceBuildTemplates" />
        <CallTarget Targets="_nBuildKit_Build_Test_Unit_MsTest_PrepareWorkspace" />
        <CallTarget Targets="_nBuildKit_Build_Test_Unit_MsTest_SortFilesByDirectory" />
        <CallTarget Targets="_nBuildKit_Build_Test_Unit_MsTest_Execute" />
    <Target
        DependsOnTargets="_nBuildKit_Build_Test_Unit_MsTest_DisplayInfo"
        Name="nBuildKit_Build_Test_Unit_MsTest_Run">
    </Target>

    <!-- Display info -->
        <Message Text="Running unit tests with MsTest ..." />
    <Target
        DependsOnTargets="_nBuildKit_Build_Test_Unit_MsTest_DebugLog"
        Name="_nBuildKit_Build_Test_Unit_MsTest_DisplayInfo">
    </Target>

    <Target
        Condition="$(ShouldDisplayDebugLog)"
        DependsOnTargets="_nBuildKit_Build_Test_Unit_MsTest_ReplaceBuildTemplates"
        Name="_nBuildKit_Build_Test_Unit_MsTest_DebugLog">
        <Message
            Importance="low"
            Text="Project directory structure:" />
        <Message
            Importance="low"
            Text="The workspace is located at:                                                     $(DirWorkspace)" />
        <Message
            Importance="low"
            Text="The directory containing the OpenCover unit test coverage reports is located at: $(DirReportGeneratorOutput)" />
        <Message
            Importance="low"
            Text="The directory containing the NuGet packages is located at:                       $(DirPackages)" />
        <Message
            Importance="low"
            Text="The directory containing the nBuildKit files is located at:                      $(DirNBuildKitMsBuild)" />
        <Message
            Importance="low"
            Text="The directory containing the nBuildKit scripts is located at:                    $(DirNBuildKitMsBuildExtensions)" />
        <Message
            Importance="low"
            Text="The directory containing the nBuildKit templates is located at:                  $(DirNBuildKitMsBuildTemplates)" />
        <Message
            Importance="low"
            Text=" " />

        <Message
            Importance="low"
            Text="The MsTest report will be located at:                                            $(FileReportMsTestExpanded)" />
        <Message
            Importance="low"
            Text="The OpenCover XML report will be located at:                                     $(FileReportOpenCoverXmlExpanded)" />
        <Message
            Importance="low"
            Text="The OpenCover CSV report will be located at:                                     $(FileReportOpenCoverCsvExpanded)" />
        <Message
            Importance="low"
            Text="The ReportGenerator XML summary report will be located at:                       $(FileReportReportGeneratorXmlSummary)" />
        <Message
            Importance="low"
            Text=" " />

        <Message
            Importance="low"
            Text="The MsTest command line executable is located at:                                $(ToolsExternalMsTestPath)" />
        <Message
            Importance="low"
            Text="OpenCover command line executable is located at:                                 $(ToolsExternalOpenCoverPath)" />
        <Message
            Importance="low"
            Text="ReportGenerator command line executable is located at:                           $(ToolsExternalReportGeneratorPath)" />
        <Message
            Importance="low"
            Text=" " />
    </Target>

    <Target Name="_nBuildKit_Build_Test_Unit_MsTest_GetToolPaths">
        <Error
            Condition="!Exists('$(DirPackages)') AND '$(ShouldExecute)' == 'true' "
            Text="The packages directory does not exist. Cannot search for the unit test executables." />
        <Error
            Condition="!Exists('$(ToolsExternalMsTestPath)') AND '$(ShouldExecute)' == 'true' "
            Text="Could not locate the MsTest executable path. Cannot execute unit tests." />

        <NuGetInstall
            Condition=" '$(ToolsExternalOpenCoverPath)' == 'UNDEFINED' AND   '$(ShouldExecute)' == 'true' "
            NuGetPath="$(ToolsExternalNuGetPath)"
            PackageDirectory="$(DirPackages)"
            PackageName="OpenCover"
            PackageVersion="$(ToolsExternalOpenCoverVersion)"
            Sources="@(NuGetSources)" />
        <SearchPackagesDirectoryForToolPath
            Condition=" '$(ToolsExternalOpenCoverPath)' == 'UNDEFINED' AND   '$(ShouldExecute)' == 'true' "
            FileToLocate="opencover.console.exe"
            PackagesDir="$(DirPackages)">
            <Output
                PropertyName="ToolsExternalOpenCoverPath"
                TaskParameter="Path" />
        </SearchPackagesDirectoryForToolPath>
        <GetToolFullPath
            Condition=" '$(ToolsExternalOpenCoverPath)' != 'UNDEFINED' "
            Tool="$(ToolsExternalOpenCoverPath)">
            <Output
                PropertyName="ToolsExternalOpenCoverPath"
                TaskParameter="Path" />
        </GetToolFullPath>
        <Message
            Condition="Exists('$(ToolsExternalOpenCoverPath)') AND '$(ShouldExecute)' == 'true' "
            Importance="low"
            Text="The OpenCover executable was found at: $(ToolsExternalOpenCoverPath)" />
        <Error
            Condition="!Exists('$(ToolsExternalOpenCoverPath)') AND '$(ShouldExecute)' == 'true' "
            Text="Could not locate the OpenCover executable path. Cannot execute unit tests." />

        <NuGetInstall
            Condition=" '$(ToolsExternalReportGeneratorPath)' == 'UNDEFINED' AND   '$(ShouldExecute)' == 'true' "
            NuGetPath="$(ToolsExternalNuGetPath)"
            PackageDirectory="$(DirPackages)"
            PackageName="ReportGenerator"
            PackageVersion="$(ToolsExternalReportGeneratorVersion)"
            Sources="@(NuGetSources)" />
        <SearchPackagesDirectoryForToolPath
            Condition=" '$(ToolsExternalReportGeneratorPath)' == 'UNDEFINED' AND   '$(ShouldExecute)' == 'true' "
            FileToLocate="ReportGenerator.exe"
            PackagesDir="$(DirPackages)">
            <Output
                PropertyName="ToolsExternalReportGeneratorPath"
                TaskParameter="Path" />
        </SearchPackagesDirectoryForToolPath>
        <GetToolFullPath
            Condition=" '$(ToolsExternalReportGeneratorPath)' != 'UNDEFINED' "
            Tool="$(ToolsExternalReportGeneratorPath)">
            <Output
                PropertyName="ToolsExternalReportGeneratorPath"
                TaskParameter="Path" />
        </GetToolFullPath>
        <Message
            Condition="Exists('$(ToolsExternalReportGeneratorPath)') AND '$(ShouldExecute)' == 'true' "
            Importance="low"
            Text="The ReportGenerator executable was found at: $(ToolsExternalReportGeneratorPath)" />
        <Warning
            Condition="!Exists('$(ToolsExternalReportGeneratorPath)') AND '$(ShouldExecute)' == 'true' "
            Text="Could not locate the ReportGenerator executable path. Cannot generate the unit test coverage reports." />

        <NuGetInstall
            Condition=" '$(ToolsExternalOpenCoverToCoberturaConverterPath)' == 'UNDEFINED' AND   '$(ShouldExecute)' == 'true' "
            NuGetPath="$(ToolsExternalNuGetPath)"
            PackageDirectory="$(DirPackages)"
            PackageName="OpenCoverToCoberturaConverter"
            PackageVersion="$(ToolsExternalOpenCoverToCoberturaConverterVersion)"
            Sources="@(NuGetSources)" />
        <SearchPackagesDirectoryForToolPath
            Condition=" '$(ToolsExternalOpenCoverToCoberturaConverterPath)' == 'UNDEFINED' AND   '$(ShouldExecute)' == 'true' "
            FileToLocate="OpenCoverToCoberturaConverter.exe"
            PackagesDir="$(DirPackages)">
            <Output
                PropertyName="ToolsExternalOpenCoverToCoberturaConverterPath"
                TaskParameter="Path" />
        </SearchPackagesDirectoryForToolPath>
        <GetToolFullPath
            Condition=" '$(ToolsExternalOpenCoverToCoberturaConverterPath)' != 'UNDEFINED' "
            Tool="$(ToolsExternalOpenCoverToCoberturaConverterPath)">
            <Output
                PropertyName="ToolsExternalOpenCoverToCoberturaConverterPath"
                TaskParameter="Path" />
        </GetToolFullPath>
        <Message
            Condition="Exists('$(ToolsExternalOpenCoverToCoberturaConverterPath)') AND '$(ShouldExecute)' == 'true' "
            Text="The OpenCoverToCoberturaConverter executable was found at: $(ToolsExternalOpenCoverToCoberturaConverterPath)" />
        <Warning
            Condition="!Exists('$(ToolsExternalOpenCoverToCoberturaConverterPath)') AND '$(ShouldExecute)' == 'true' "
            Text="Could not locate the OpenCoverToCoberturaConverter executable path. Cannot convert code coverage reports." />
    </Target>

    <Target
        DependsOnTargets="nBuildKit_Shared_TemplateTokens_Initialize"
        Name="_nBuildKit_Build_Test_Unit_MsTest_ReplaceBuildTemplates">
        <Message
            Importance="low"
            Text="Resolving build templates ..." />

        <TemplateText
            Template="$(FileReportMsTest)"
            Tokens="@(TemplateTokens)">
            <Output
                PropertyName="FileReportMsTestExpanded"
                TaskParameter="Result" />
        </TemplateText>

        <TemplateText
            Template="$(FileReportOpenCoverXml)"
            Tokens="@(TemplateTokens)">
            <Output
                PropertyName="FileReportOpenCoverXmlExpanded"
                TaskParameter="Result" />
        </TemplateText>

        <TemplateText
            Template="$(FileReportOpenCoverCsv)"
            Tokens="@(TemplateTokens)">
            <Output
                PropertyName="FileReportOpenCoverCsvExpanded"
                TaskParameter="Result" />
        </TemplateText>

        <TemplateText
            Template="$(DirReportOpenCoverCobertura)"
            Tokens="@(TemplateTokens)">
            <Output
                PropertyName="DirReportOpenCoverCoberturaExpanded"
                TaskParameter="Result" />
        </TemplateText>
    </Target>

    <Target
        DependsOnTargets="_nBuildKit_Build_Test_Unit_MsTest_ReplaceBuildTemplates"
        Name="_nBuildKit_Build_Test_Unit_MsTest_PrepareWorkspace">
        <CreateProperty
            Value="$([System.IO.Path]::GetDirectoryName('$(FileReportMsTestExpanded)'))">
            <Output
                PropertyName="DirToCreate"
                TaskParameter="Value" />
        </CreateProperty>
        <MakeDir
            Condition="!Exists('$(DirToCreate)') AND '$(ShouldExecute)' == 'true' "
            Directories="$(DirToCreate)" />

        <CreateProperty Value="$([System.IO.Path]::GetDirectoryName('$(FileReportOpenCoverXmlExpanded)'))">
            <Output
                PropertyName="DirToCreate"
                TaskParameter="Value" />
        </CreateProperty>
        <MakeDir
            Condition="!Exists('$(DirToCreate)') AND '$(ShouldExecute)' == 'true' "
            Directories="$(DirToCreate)" />

        <CreateProperty Value="$([System.IO.Path]::GetDirectoryName('$(FileReportOpenCoverCsvExpanded)'))">
            <Output
                PropertyName="DirToCreate"
                TaskParameter="Value" />
        </CreateProperty>
        <MakeDir
            Condition="!Exists('$(DirToCreate)') AND '$(ShouldExecute)' == 'true' "
            Directories="$(DirToCreate)" />

        <!-- This directory is always present although users may change the location -->
        <MakeDir
            Condition="!Exists('$(DirReportGeneratorOutput)') AND '$(ShouldExecute)' == 'true' "
            Directories="$(DirReportGeneratorOutput)" />
    </Target>

    <Target Name="_nBuildKit_Build_Test_Unit_MsTest_SortFilesByDirectory">
        <SortFilesByDirectory Files="@(UnitTestAssemblies)" >
            <Output
                ItemName="UnitTestDirectories"
                TaskParameter="Directories" />
        </SortFilesByDirectory>
    </Target>

    <Target
        DependsOnTargets="_nBuildKit_Build_Test_Unit_MsTest_GetToolPaths;_nBuildKit_Build_Test_Unit_MsTest_ReplaceBuildTemplates;_nBuildKit_Build_Test_Unit_MsTest_PrepareWorkspace;_nBuildKit_Build_Test_Unit_MsTest_SortFilesByDirectory"
        Name="_nBuildKit_Build_Test_Unit_MsTest_RunTests"
        Outputs="%(UnitTestDirectories.Identity)">
        <!--
            Create the ItemGroup dynamically because creating an ItemGroup in the target with the dynamically
            created properties doesn't work because the wildcards are not always expanded for some reason.
        -->
        <CreateItem
            Include="%(UnitTestDirectories.Files)">
            <Output
                ItemName="UnitTestAssembliesForDirectory"
                TaskParameter="Include" />
        </CreateItem>
        <CreateProperty Value="@(UnitTestAssemblies->'/testcontainer:%22%22%(FullPath)%22%22', ' ')">
            <Output
                PropertyName="AssembliesToTest"
                TaskParameter="Value" />
        </CreateProperty>

        <Message Text="Executing unit tests for: " />
        <Message Text="--- %(UnitTestAssemblies.FullPath)" />
        <OpenCover
            BinDir="%(UnitTestDirectories.FullPath)"
            Condition=" Exists('$(ToolsExternalOpenCoverPath)') AND '$(ShouldExecute)' == 'true' "
            OpenCoverExcludeAttributes="@(OpenCoverIgnoreAttributes)"
            OpenCoverExe="$(ToolsExternalOpenCoverPath)"
            OpenCoverFilters="@(OpenCoverFilters->'%(Identity)', ' ')"
            OpenCoverOutput="$([System.IO.Path]::GetDirectoryName('$(FileReportOpenCoverXmlExpanded)'))\$([System.IO.Path]::GetFileNameWithoutExtension('$(FileReportOpenCoverXmlExpanded)'))-%(UnitTestDirectories.Index).$([System.IO.Path]::GetExtension('$(FileReportOpenCoverXmlExpanded)'))"
            UnitTestArguments="$(AssembliesToTest) /resultsfile:&quot;&quot;$([System.IO.Path]::GetDirectoryName('$(FileReportMsTestExpanded)'))\$([System.IO.Path]::GetFileNameWithoutExtension('$(FileReportMsTestExpanded)'))-%(UnitTestDirectories.Index).$([System.IO.Path]::GetExtension('$(FileReportMsTestExpanded)'))&quot;&quot;"
            UnitTestExe="$(ToolsExternalMsTestPath)" />
    </Target>

    <PropertyGroup>
        <FileReportReportGeneratorXmlSummary>$(DirReportGeneratorOutput)\Summary.xml</FileReportReportGeneratorXmlSummary>
    </PropertyGroup>
    <Target
        DependsOnTargets="_nBuildKit_Build_Test_Unit_MsTest_ReplaceBuildTemplates;_nBuildKit_Build_Test_Unit_MsTest_RunTests"
        Name="_nBuildKit_Build_Test_Unit_MsTest_Execute">
        <ItemGroup>
            <FilesReportOpenCoverXml Include="$([System.IO.Path]::GetDirectoryName('$(FileReportOpenCoverXmlExpanded)'))\$([System.IO.Path]::GetFileNameWithoutExtension('$(FileReportOpenCoverXmlExpanded)'))-*.$([System.IO.Path]::GetExtension('$(FileReportOpenCoverXmlExpanded)'))" />
        </ItemGroup>

        <ReportGenerator
            Condition=" Exists('$(ToolsExternalReportGeneratorPath)') AND '$(ShouldExecute)' == 'true' "
            OpenCoverOutputFiles="@(FilesReportOpenCoverXml)"
            OutputDir="$(DirReportGeneratorOutput)"
            ReportGeneratorExe="$(ToolsExternalReportGeneratorPath)" />

        <ReportGeneratorOutputToCsv
            Condition="Exists('$(FileReportReportGeneratorXmlSummary)') AND '$(ShouldExecute)' == 'true' "
            InputFile="$(FileReportReportGeneratorXmlSummary)"
            OutputFile="$(FileReportOpenCoverCsvExpanded)" />

        <Exec
            Command="&quot;$(ToolsExternalOpenCoverToCoberturaConverterPath)&quot; -input:&quot;%(FilesReportOpenCoverXml.Identity)&quot; -output:&quot;$([System.IO.Path]::GetDirectoryName('$(DirReportOpenCoverCoberturaExpanded)'))\cobertura-$([System.IO.Path]::GetFileName('%(FilesReportOpenCoverXml.Identity)'))&quot; -sources:&quot;$(DirSrc)&quot;"
            Condition="Exists('$(ToolsExternalOpenCoverToCoberturaConverterPath)') AND '$(ShouldExecute)' == 'true' " />
    </Target>
 </Project>