<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0"
         DefaultTargets="nBuildKit_Test_Unit_NUnit_Run"
         xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <!-- Defines whether the current script file has been loaded / imported or not -->
        <ExistsTestUnitNUnit>true</ExistsTestUnitNUnit>
        
        <!-- The full path to the settings file that contains all the settings for the build process -->
        <BuildPropertyFile Condition=" '$(BuildPropertyFile)' == '' ">UNDEFINED</BuildPropertyFile>
    </PropertyGroup>

    <Import Project="$(BuildPropertyFile)"
            Condition="Exists('$(BuildPropertyFile)') AND '$(ExistsSettings)' != 'true' " />
    
    <PropertyGroup>
        <!-- Build flags -->
        <ShouldDisplayDebugLog Condition=" '$(ShouldDisplayDebugLog)' == '' ">false</ShouldDisplayDebugLog>
        <ShouldExecute Condition=" '$(ShouldExecute)' == '' ">true</ShouldExecute>
        
        <!-- Build configuration -->
        <Configuration Condition=" '$(Configuration)' == '' ">Release</Configuration>
        <Platform Condition=" '$(Platform)' == '' ">Any CPU</Platform>
        <PlatformWithoutSpaces>$(Platform.Replace(" ",""))</PlatformWithoutSpaces>
        
        <!-- Directories -->
        <DirWorkspace Condition=" '$(DirWorkspace)' == '' ">$([System.IO.Path]::GetDirectoryName('$(BuildPropertyFile)'))</DirWorkspace>
        <DirBuild Condition=" '$(DirBuild)' == '' ">$(DirWorkspace)\build</DirBuild>
        <DirBuildBin Condition=" '$(DirBuildBin)' == '' ">$(DirBuild)\bin</DirBuildBin>
        <DirBuildBinPlatformConfig Condition=" '$(DirBuildBinPlatformConfig)' == '' ">$([System.IO.Path]::GetFullPath('$(DirBuildBin)\$(PlatformWithoutSpaces)\$(Configuration)\'))</DirBuildBinPlatformConfig>
        <DirBuildLogs Condition=" '$(DirBuildLogs)' == '' ">$(DirBuild)\logs</DirBuildLogs>
        <DirBuildTemp Condition=" '$(DirBuildTemp)' == '' ">$(DirBuild)\temp</DirBuildTemp>
        <DirPackages Condition=" '$(DirPackages)' == '' ">$(DirWorkspace)\packages</DirPackages>
        <DirReportGeneratorOutput Condition=" '$(DirReportGeneratorOutput)' == '' ">$(DirBuildLogs)\coverage</DirReportGeneratorOutput>
        
        <!-- nBuildKit directories -->
        <DirMsBuildExtensions Condition=" '$(DirMsBuildExtensions)' == '' ">$(MSBuildProjectDirectory)\extensions</DirMsBuildExtensions>
        <DirMsBuildShared Condition=" '$(DirMsBuildShared)' == '' ">$(MSBuildProjectDirectory)</DirMsBuildShared>
        
        <!-- Files -->
        <FileReportOpenCoverXml Condition=" '$(FileReportOpenCoverXml)' == '' ">$(DirBuildLogs)\opencover.xml</FileReportOpenCoverXml>
        <FileReportOpenCoverCsv Condition=" '$(FileReportOpenCoverCsv)' == '' ">$(DirBuildLogs)\coverage.csv</FileReportOpenCoverCsv>
        
        <FileReportReportGeneratorXmlSummary>$(DirReportGeneratorOutput)\Summary.xml</FileReportReportGeneratorXmlSummary>
        
        <!-- Unit tests -->
        <UnitTestAssemblyNamePrefix Condition=" '$(UnitTestAssemblyNamePrefix)' == '' " >test.unit</UnitTestAssemblyNamePrefix>
    </PropertyGroup>
    
    <Import Project="$(DirMsBuildShared)\shared.templatetokens.msbuild" 
            Condition="Exists('$(DirMsBuildShared)\shared.templatetokens.msbuild') AND '$(ExistsSharedTemplateTokens)' != 'true' " />
    
    <Import Project="$(DirMsBuildExtensions)\OpenCover.msbuild"
            Condition="Exists('$(DirMsBuildExtensions)\OpenCover.msbuild') AND '$(ExistsExtensionsOpenCover)' != 'true' "/>
    <Import Project="$(DirMsBuildExtensions)\ReportGenerator.msbuild"
            Condition="Exists('$(DirMsBuildExtensions)\ReportGenerator.msbuild') AND '$(ExistsExtensionsReportGenerator)' != 'true' "/>
    <Import Project="$(DirMsBuildExtensions)\ReportGeneratorOutputToCsv.msbuild"
            Condition="Exists('$(DirMsBuildExtensions)\ReportGeneratorOutputToCsv.msbuild') AND '$(ExistsExtensionsReportGeneratorOutputToCsv)' != 'true' "/> 
    <Import Project="$(DirMsBuildExtensions)\SearchPackagesDirectoryForToolPath.msbuild" 
            Condition="Exists('$(DirMsBuildExtensions)\SearchPackagesDirectoryForToolPath.msbuild') AND '$(ExistsExtensionsSearchPackagesDirectoryForToolPath)' != 'true' " />
    <Import Project="$(DirMsBuildExtensions)\TemplateText.msbuild" 
            Condition="Exists('$(DirMsBuildExtensions)\TemplateText.msbuild') AND '$(ExistsExtensionsTemplateText)' != 'true' " />
            
    <Target Name="nBuildKit_Test_Unit_NUnit_Run" 
            DependsOnTargets="_nBuildKit_Test_Unit_NUnit_DisplayInfo">
        <CallTarget Targets="_nBuildKit_Test_Unit_NUnit_Execute" />
    </Target>
    
    <!-- Display info -->
    <Target Name="_nBuildKit_Test_Unit_NUnit_DisplayInfo" 
            DependsOnTargets="_nBuildKit_Test_Unit_NUnit_DebugLog">
        <Message Text="Running unit tests with NUnit ..." />
    </Target>
    
    <Target Name="_nBuildKit_Test_Unit_NUnit_DebugLog" 
            Condition="$(ShouldDisplayDebugLog)"
            DependsOnTargets="_nBuildKit_Test_Unit_NUnit_ReplaceBuildTemplates">
        <Message Text="Project directory structure:" />
        <Message Text="The workspace is located at:                                                     $(DirWorkspace)" />
        <Message Text="The directory containing the build output is located at:                         $(DirBuild)" />
        <Message Text="The directory containing the generated binaries is located at:                   $(DirBuildBinPlatformConfig)" />
        <Message Text="The directory containing the build logs is located at:                           $(DirBuildLogs)" />
        <Message Text="The directory containing the OpenCover unit test coverage reports is located at: $(DirReportGeneratorOutput)" />
        <Message Text="The directory containing the temporary build files is located at:                $(DirBuildTemp)" />
        <Message Text="The directory containing the NuGet packages is located at:                       $(DirPackages)" />
        <Message Text="The directory containing the nBuildKit scripts is located at:                    $(DirMsBuildExtensions)" />
        <Message Text=" " />
        
        <Message Text="The OpenCover XML report will be located at:               $(FileReportOpenCoverXmlExpanded)" />
        <Message Text="The OpenCover CSV report will be located at:               $(FileReportOpenCoverCsvExpanded)" />
        <Message Text="The ReportGenerator XML summary report will be located at: $(FileReportReportGeneratorXmlSummary)" />
        <Message Text=" " />
    </Target>
    
    <Target Name="_nBuildKit_Test_Unit_NUnit_ReplaceBuildTemplates" 
            DependsOnTargets="nBuildKit_Shared_TemplateTokens_Initialize">
        <Message Text="Resolving build templates ..." />
        
        <TemplateText Template="$(FileReportOpenCoverXml)"
                      Tokens="@(TemplateTokens)">
            <Output TaskParameter="Result" PropertyName="FileReportOpenCoverXmlExpanded" />
        </TemplateText>
        
        <TemplateText Template="$(FileReportOpenCoverCsv)"
                      Tokens="@(TemplateTokens)">
            <Output TaskParameter="Result" PropertyName="FileReportOpenCoverCsvExpanded" />
        </TemplateText>
    </Target>
    
    <Target Name="_nBuildKit_Test_Unit_NUnit_Execute"
            DependsOnTargets="_nBuildKit_Test_Unit_NUnit_ReplaceBuildTemplates">
        <Error Text="The packages directory does not exist. Cannot search for the unit test executables."
               Condition="!Exists('$(DirPackages)') AND '$(ShouldExecute)' == 'true' "/>
        
        <MakeDir Directories="$(DirBuildTemp)" Condition="!Exists('$(DirBuildTemp)') AND '$(ShouldExecute)' == 'true' " />
        <MakeDir Directories="$(DirBuildLogs)" Condition="!Exists('$(DirBuildLogs)') AND '$(ShouldExecute)' == 'true' " />
        <MakeDir Directories="$(DirReportGeneratorOutput)" Condition="!Exists('$(DirReportGeneratorOutput)') AND '$(ShouldExecute)' == 'true' " />
        
        <SearchPackagesDirectoryForToolPath PackagesDir="$(DirPackages)" 
                                            FileToLocate="nunit-console-x86.exe"
                                            Condition=" '$(ShouldExecute)' == 'true' ">
            <Output TaskParameter="Path" PropertyName="ToolsExternalNUnitConsolePath" />
        </SearchPackagesDirectoryForToolPath>
        <Error Text="Could not locate the NUnit executable path. Cannot execute unit tests."
               Condition="!Exists('$(ToolsExternalNUnitConsolePath)') AND '$(ShouldExecute)' == 'true' "/>
        
        <SearchPackagesDirectoryForToolPath PackagesDir="$(DirPackages)" 
                                            FileToLocate="opencover.console.exe"
                                            Condition=" '$(ShouldExecute)' == 'true' ">
            <Output TaskParameter="Path" PropertyName="ToolsExternalOpenCoverPath" />
        </SearchPackagesDirectoryForToolPath>
        <Error Text="Could not locate the OpenCover executable path. Cannot execute unit tests."
               Condition="!Exists('$(ToolsExternalOpenCoverPath)') AND '$(ShouldExecute)' == 'true' "/>
        
        <SearchPackagesDirectoryForToolPath PackagesDir="$(DirPackages)" 
                                            FileToLocate="ReportGenerator.exe"
                                            Condition=" '$(ShouldExecute)' == 'true' ">
            <Output TaskParameter="Path" PropertyName="ToolsExternalReportGeneratorPath" />
        </SearchPackagesDirectoryForToolPath>
        <Warning Text="Could not locate the ReportGenerator executable path. Cannot generate the unit test coverage reports."
                 Condition="!Exists('$(ToolsExternalReportGeneratorPath)') AND '$(ShouldExecute)' == 'true' "/>
        
        <ItemGroup Condition=" '@(UnitTestAssemblies)' == '' ">
            <UnitTestAssemblies Include="$(DirBuildBinPlatformConfig)\**\$(UnitTestAssemblyNamePrefix)*.dll" />
        </ItemGroup>
        <ItemGroup Condition=" '@(OpenCoverIgnoreAttributes)' == '' ">
            <OpenCoverIgnoreAttributes Include="System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverageAttribute" />
            <OpenCoverIgnoreAttributes Include="System.Runtime.CompilerServices.CompilerGeneratedAttribute" />
        </ItemGroup>
        <ItemGroup Condition=" '@(OpenCoverFilters)' == '' ">
            <!-- NOTE: Use the ASCII encodings for * (%2A) to avoid MsBuild trying to make sense out of the text -->
            <OpenCoverFilters Include="+[%2A]%2A" />
        </ItemGroup>
        
        <OpenCover OpenCoverExe="$(ToolsExternalOpenCoverPath)"
                   OpenCoverOutput="$(FileReportOpenCoverXmlExpanded)"
                   OpenCoverFilters="@(OpenCoverFilters->'%(Identity)', ' ')"
                   OpenCoverExcludeAttributes="@(OpenCoverIgnoreAttributes)"
                   UnitTestExe="$(ToolsExternalNUnitConsolePath)"
                   UnitTestArguments="/framework:net-4.5 /result:&quot;nunit-console.xml&quot; /work:&quot;$(DirBuildLogs)&quot; /noshadow /domain:single @(UnitTestAssemblies->'%22%(FullPath)%22', ' ')"
                   BinDir="$(DirBuildBinPlatformConfig)" 
                   Condition=" '$(ShouldExecute)' == 'true' "/>
        
        <ReportGenerator ReportGeneratorExe="$(ToolsExternalReportGeneratorPath)"
                         OpenCoverOutputFile="$(FileReportOpenCoverXmlExpanded)"
                         OutputDir="$(DirReportGeneratorOutput)" 
                         Condition="Exists('$(ToolsExternalReportGeneratorPath)') AND '$(ShouldExecute)' == 'true' "/>
                         
        <ReportGeneratorOutputToCsv InputFile="$(FileReportReportGeneratorXmlSummary)"
                                    OutputFile="$(FileReportOpenCoverCsvExpanded)" 
                                    Condition="Exists('$(FileReportReportGeneratorXmlSummary)') AND '$(ShouldExecute)' == 'true' "/>
    </Target>
 </Project>